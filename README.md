# Doctors Custom Post Type Plugin

WordPress плагин для управления списком врачей с кастомными полями, таксономиями и фильтрацией.

## Локальный запуск через Docker

### Требования

- Docker
- Docker Compose

### Быстрый старт

```bash
# 1. Копирование файла окружения
cp sample.env .env

# 2. Запуск контейнеров
docker-compose up -d

# 3. Откройте в браузере
# http://localhost:8080
```

### Конфигурация порта

Отредактируйте файл `.env` для изменения порта:

```env
WP_PORT=8080
```

После изменения перезапустите контейнеры:

```bash
docker-compose down
docker-compose up -d
```

### Учетные данные WordPress

- **Логин**: `wordpress`
- **Пароль**: `wordpress`

### Демо-данные

При первом запуске демо-данные создаются автоматически **только если в базе данных нет записей типа "doctors"**:

- 5 специализаций (Терапевт, Кардиолог, Невролог, Дерматолог, Педиатр)
- 4 города (Москва, Санкт-Петербург, Новосибирск, Екатеринбург)
- 10 врачей с заполненными полями

После создания данных вы увидите уведомление в админке.

Это гарантирует, что демо-данные не будут создаваться повторно при перезапуске Docker или повторной активации плагина.

**Почему нет секции удаления (uninstall)?**

Функционал полного удаления плагина (удаление CPT, таксономий, мета-полей и всех записей) в задании не был прописан. В некоторых случаях удаление данных может привести к необратимой потере информации, поэтому принято решение не реализовывать этот функционал.

### Остановка

```bash
docker-compose down
```

Для удаления всех данных (включая базу данных):

```bash
docker-compose down -v
```

## Установка вручную

Рекомендуется использовать докер для запуска, тк там есть и демо данные. Для ручного запуска можно переделать демо данные в другом формате. Но в задаче не было явного указания способа передачи демо данных. Выбрал более простой.

1. Скопируйте папку `doctors-plugin` в директорию `wp-content/plugins/` вашего WordPress сайта
2. Активируйте плагин через админ-панель WordPress (Plugins → Activate)
3. После активации автоматически создастся тип записи "Врачи" и таксономии

## URL для проверки

- **Архив врачей**: `/doctors/`
- **Одиночная запись врача**: `/doctors/doctor-name/`

## Структура плагина

```
doctors-plugin/
├── doctors-plugin.php          # Главный файл плагина
├── includes/
│   ├── register-cpt.php        # Регистрация CPT "Врачи"
│   ├── register-taxonomies.php # Регистрация таксономий
│   ├── meta-boxes.php          # Кастомные мета-поля
│   ├── template-loader.php     # Загрузка шаблонов
│   └── archive-filter.php      # Фильтрация на архиве
└── templates/
    ├── single-doctor.php       # Шаблон одиночной записи
    ├── archive-doctors.php     # Шаблон архива
    └── doctors-styles.css      # Стили

doctors-demo/
└── doctors-demo-data.php       # MU-плагин для демо-данных
```

## Кастомные поля

При создании/редактировании врача доступны следующие мета-поля:

1. **Стаж врача (лет)** - числовое поле (0-100)
2. **Цена от (руб)** - числовое поле, минимальная цена приема
3. **Рейтинг (0-5)** - дробное число от 0 до 5

## Таксономии

1. **Специализация** (hierarchical) - например: "Терапевт", "Кардиолог", "Невролог"
2. **Город** (hierarchical) - например: "Москва", "Санкт-Петербург"

## Фильтрация на странице архива

На странице `/doctors/` доступны фильтры:

- **По специализации** - выпадающий список всех специализаций
- **По городу** - выпадающий список всех городов
- **Сортировка**:
  - По рейтингу (убывание)
  - По цене (возрастание)
  - По стажу (убывание)

Фильтрация работает через GET-параметры:
```
/doctors/?specialization=kardiolog&city=moskva&sort=rating_desc
```

## Архитектурные решения

### pre_get_posts для фильтрации

Для фильтрации и сортировки на архиве используется хук `pre_get_posts`. Это позволяет:
- Изменять основной запрос до его выполнения
- Не создавать дополнительных WP_Query запросов
- Сохранять корректную работу пагинации
- Использовать стандартную WordPress логику

### Почему таксономия "Город" иерархическая?

Выбрана иерархическая структура для городов по следующим причинам:
- Возможность группировки городов по регионам/странам
- Более удобный UI в админке (древовидная структура)
- Потенциальная возможность расширения (регионы → города → районы)
- Фильтрация по родительскому термину включает все дочерние

### Кастомные поля без ACF

Мета-поля реализованы через нативный WordPress API (add_meta_box) по причине:
- Минимум зависимостей - плагин работает сам по себе
- Полный контроль над логикой сохранения и вывода
- Легче поддерживать и модифицировать под конкретные нужды
- Нет необходимости в дополнительных плагинах

### Экранирование и санитизация

Во всех местах, где выводятся или используются пользовательские данные:
- `esc_html()` - для текстового вывода
- `esc_url()` - для URL
- `esc_attr()` - для атрибутов HTML
- `sanitize_text_field()` - для очистки входных данных
- `absint()` - для числовых ID
- `wp_kses_post()` - для разрешенного HTML контента

## Техническая информация

- **Версия WordPress**: 6.x и выше
- **Зависимости**: нет (работает без ACF)
- **i18n**: поддержка русского и английского языков
- **REST API**: CPT и таксономии добавлены в REST API (`show_in_rest => true`)

## Возможные улучшения

1. Добавление AJAX-фильтрации без перезагрузки страницы
2. Интеграция с ACF для более сложных полей
3. Добавление изображений для таксономий
4. Реализация поиска по врачам
5. Добавление отзывов для врачей
