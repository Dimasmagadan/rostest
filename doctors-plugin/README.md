# Doctors Custom Post Type Plugin

WordPress плагин для управления списком врачей с кастомными полями, таксономиями и фильтрацией.

## Установка

1. Скопируйте папку `doctors-plugin` в директорию `wp-content/plugins/` вашего WordPress сайта
2. Активируйте плагин через админ-панель WordPress (Plugins → Activate)
3. После активации автоматически создастся тип записи "Врачи" и таксономии

## URL для проверки

- **Архив врачей**: `/doctors/` или `/врачи/` (зависит от настроек пермалинков)
- **Одиночная запись врача**: `/doctors/doctor-name/` или `/врачи/имя-врача/`

## Структура плагина

```
doctors-plugin/
├── doctors-plugin.php          # Главный файл плагина
├── includes/
│   ├── register-cpt.php        # Регистрация CPT "Врачи"
│   ├── register-taxonomies.php # Регистрация таксономий
│   ├── meta-boxes.php          # Кастомные мета-поля
│   ├── template-loader.php     # Загрузка шаблонов
│   └── archive-filter.php      # Фильтрация на архиве
└── templates/
    ├── single-doctor.php       # Шаблон одиночной записи
    ├── archive-doctors.php     # Шаблон архива
    └── doctors-styles.css      # Стили
```

## Кастомные поля

При создании/редактировании врача доступны следующие мета-поля:

1. **Стаж врача (лет)** - числовое поле (0-100)
2. **Цена от (руб)** - числовое поле, минимальная цена приема
3. **Рейтинг (0-5)** - дробное число от 0 до 5

## Таксономии

1. **Специализация** (hierarchical) - например: "Терапевт", "Кардиолог", "Невролог"
2. **Город** (hierarchical) - например: "Москва", "Санкт-Петербург"

## Фильтрация на странице архива

На странице `/doctors/` доступны фильтры:

- **По специализации** - выпадающий список всех специализаций
- **По городу** - выпадающий список всех городов
- **Сортировка**:
  - По рейтингу (убывание)
  - По цене (возрастание)
  - По стажу (убывание)

Фильтрация работает через GET-параметры:
```
/doctors/?specialization=kardiolog&city=moskva&sort=rating_desc
```

## Архитектурные решения

### pre_get_posts для фильтрации

Для фильтрации и сортировки на архиве используется хук `pre_get_posts`. Это позволяет:
- Изменять основной запрос до его выполнения
- Не создавать дополнительных WP_Query запросов
- Сохранять корректную работу пагинации
- Использовать стандартную WordPress логику

### Почему таксономия "Город" иерархическая?

Выбрана иерархическая структура для городов по следующим причинам:
- Возможность группировки городов по регионам/странам
- Более удобный UI в админке (древовидная структура)
- Потенциальная возможность расширения (регионы → города → районы)
- Фильтрация по родительскому термину включает все дочерние

### Кастомные поля без ACF

Мета-поля реализованы через нативный WordPress API (add_meta_box) по причине:
- Минимум зависимостей - плагин работает сам по себе
- Полный контроль над логикой сохранения и вывода
- Легче поддерживать и модифицировать под конкретные нужды
- Нет необходимости в дополнительных плагинах

### Экранирование и санитизация

Во всех местах, где выводятся или используются пользовательские данные:
- `esc_html()` - для текстового вывода
- `esc_url()` - для URL
- `esc_attr()` - для атрибутов HTML
- `sanitize_text_field()` - для очистки входных данных
- `absint()` - для числовых ID
- `wp_kses_post()` - для разрешенного HTML контента

## Демо-данные

Для создания демо-данных используйте следующий код (добавьте в functions.php темы или в плагин):

```php
function doctors_create_demo_data() {
    // Создаем специализации
    $specializations = array( 'Терапевт', 'Кардиолог', 'Невролог', 'Дерматолог', 'Педиатр' );
    foreach ( $specializations as $spec ) {
        wp_insert_term( $spec, 'specialization' );
    }

    // Создаем города
    $cities = array( 'Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург' );
    foreach ( $cities as $city ) {
        wp_insert_term( $city, 'city' );
    }

    // Создаем 10 врачей
    $doctors = array(
        array(
            'name'        => 'Иванов Иван Иванович',
            'spec'        => 'Кардиолог',
            'city'        => 'Москва',
            'experience'  => 15,
            'price'       => 2500,
            'rating'      => 4.8,
            'excerpt'     => 'Опытный кардиолог с 15-летним стажем работы.',
            'content'     => 'Закончил МГУ им. Ломоносова. Специализируется на лечении заболеваний сердечно-сосудистой системы.',
        ),
        array(
            'name'        => 'Петрова Анна Сергеевна',
            'spec'        => 'Терапевт',
            'city'        => 'Москва',
            'experience'  => 8,
            'price'       => 1500,
            'rating'      => 4.5,
            'excerpt'     => 'Врач-терапевт широкого профиля.',
            'content'     => 'Опыт работы в городской поликлинике. Занимается диагностикой и лечением широкого спектра заболеваний.',
        ),
        array(
            'name'        => 'Сидоров Алексей Петрович',
            'spec'        => 'Невролог',
            'city'        => 'Санкт-Петербург',
            'experience'  => 20,
            'price'       => 3000,
            'rating'      => 4.9,
            'excerpt'     => 'Врач-невролог высшей категории.',
            'content'     => 'Доктор медицинских наук. Специализируется на лечении заболеваний нервной системы.',
        ),
        array(
            'name'        => 'Козлова Елена Владимировна',
            'spec'        => 'Дерматолог',
            'city'        => 'Новосибирск',
            'experience'  => 12,
            'price'       => 1800,
            'rating'      => 4.6,
            'excerpt'     => 'Дерматолог-косметолог.',
            'content'     => 'Занимается диагностикой и лечением кожных заболеваний, проводит косметологические процедуры.',
        ),
        array(
            'name'        => 'Смирнов Дмитрий Николаевич',
            'spec'        => 'Педиатр',
            'city'        => 'Екатеринбург',
            'experience'  => 10,
            'price'       => 2000,
            'rating'      => 4.7,
            'excerpt'     => 'Педиатр с опытом работы в крупных клиниках.',
            'content'     => 'Специализируется на наблюдении за здоровьем детей от рождения до 18 лет.',
        ),
        array(
            'name'        => 'Морозова Ольга Игоревна',
            'spec'        => 'Кардиолог',
            'city'        => 'Санкт-Петербург',
            'experience'  => 18,
            'price'       => 2800,
            'rating'      => 4.4,
            'excerpt'     => 'Кардиолог, специалист по ЭКГ.',
            'content'     => 'Проводит расшифровку ЭКГ, холтеровское мониторирование, консультирует пациентов с заболеваниями сердца.',
        ),
        array(
            'name'        => 'Волков Андрей Михайлович',
            'spec'        => 'Терапевт',
            'city'        => 'Новосибирск',
            'experience'  => 5,
            'price'       => 1200,
            'rating'      => 4.2,
            'excerpt'     => 'Молодой специалист с современным подходом.',
            'content'     => 'Закончил медицинский университет с отличием. Применяет современные методы диагностики.',
        ),
        array(
            'name'        => 'Николаева Мария Павловна',
            'spec'        => 'Дерматолог',
            'city'        => 'Москва',
            'experience'  => 25,
            'price'       => 3500,
            'rating'      => 4.9,
            'excerpt'     => 'Дерматолог-трихолог, эксперт.',
            'content'     => 'Специализируется на лечении заболеваний волос и кожи головы. Автор научных публикаций.',
        ),
        array(
            'name'        => 'Лебедев Сергей Викторович',
            'spec'        => 'Невролог',
            'city'        => 'Екатеринбург',
            'experience'  => 14,
            'price'       => 2200,
            'rating'      => 4.5,
            'excerpt'     => 'Невролог, специалист по головным болям.',
            'content'     => 'Занимается диагностикой и лечением головных болей, мигрени, заболеваний позвоночника.',
        ),
        array(
            'name'        => 'Кузьмина Татьяна Александровна',
            'spec'        => 'Педиатр',
            'city'        => 'Москва',
            'experience'  => 7,
            'price'       => 1800,
            'rating'      => 4.6,
            'excerpt'     => 'Педиатр-неонатолог.',
            'content'     => 'Специализируется на уходе за новорожденными, консультирует по вопросам грудного вскармливания.',
        ),
    );

    foreach ( $doctors as $doctor ) {
        $spec_term = get_term_by( 'name', $doctor['spec'], 'specialization' );
        $city_term = get_term_by( 'name', $doctor['city'], 'city' );

        $post_data = array(
            'post_title'   => $doctor['name'],
            'post_content' => $doctor['content'],
            'post_excerpt' => $doctor['excerpt'],
            'post_status'  => 'publish',
            'post_type'    => 'doctors',
        );

        $post_id = wp_insert_post( $post_data );

        if ( $post_id && $spec_term ) {
            wp_set_object_terms( $post_id, $spec_term->term_id, 'specialization' );
        }
        if ( $post_id && $city_term ) {
            wp_set_object_terms( $post_id, $city_term->term_id, 'city' );
        }

        if ( $post_id ) {
            update_post_meta( $post_id, '_doctors_experience', $doctor['experience'] );
            update_post_meta( $post_id, '_doctors_price_from', $doctor['price'] );
            update_post_meta( $post_id, '_doctors_rating', $doctor['rating'] );
        }
    }
}

// Раскомментируйте следующую строку для создания демо-данных
// add_action( 'init', 'doctors_create_demo_data' );
```

После добавления кода:
1. Раскомментируйте последнюю строку
2. Обновите любую страницу сайта
3. Закомментируйте строку обратно (чтобы данные не создавались повторно)
4. Перейдите на страницу `/doctors/` для проверки

## Техническая информация

- **Версия WordPress**: 6.x и выше
- **Зависимости**: нет (работает без ACF)
- **i18n**: поддержка русского и английского языков
- **REST API**: CPT и таксономии добавлены в REST API (`show_in_rest => true`)

## Возможные улучшения

1. Добавление AJAX-фильтрации без перезагрузки страницы
2. Интеграция с ACF для более сложных полей
3. Добавление изображений для таксономий
4. Реализация поиска по врачам
5. Добавление отзывов для врачей
